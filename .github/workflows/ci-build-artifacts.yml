name: Build Changed Packages & Upload Artifacts

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]

jobs:
  plan:
    name: Plan matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.plan.outputs.matrix }}
      count: ${{ steps.plan.outputs.count }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 需要完整历史才能 diff

      - name: Setup Git (make sure origin/main exists)
        run: |
          git fetch --no-tags --prune --depth=1 origin +refs/heads/*:refs/remotes/origin/* || true

      - name: Generate matrix
        id: plan
        shell: bash
        run: |
          node scripts/ci/plan-changed-packages.mjs > matrix.json

          # 只把 include 数组写入到输出，避免把 "range" 也作为 matrix 字段传下去
          {
            echo 'matrix<<EOF'
            jq -c '.include' matrix.json
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

          COUNT=$(jq '.include | length' matrix.json)
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          echo "Planned jobs: $COUNT"
          echo "Diff range: $(jq -r '.range' matrix.json)"

  build:
    name: Build ${{ matrix.name }}
    needs: plan
    if: needs.plan.outputs.count != '0'
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.plan.outputs.matrix) }}

    defaults:
      run:
        working-directory: ${{ matrix.dir }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: "npm"
          cache-dependency-path: ${{ matrix.dir }}/package-lock.json

      - name: Install & Build (per package)
        run: |
          set -e
          echo "Run in: $(pwd)"
          # 将 JSON 数组原样交给 Node 逐条执行，避免 Bash 转义/空格问题
          cat > /tmp/build-steps.js <<'NODE'
          const { execSync } = require('child_process');
          const steps = ${{ toJson(matrix.build) }};
          for (const cmd of steps) {
            console.log(`+ ${cmd}`);
            execSync(cmd, { stdio: 'inherit', shell: true });
          }
          NODE
          node /tmp/build-steps.js

      # 上传 zip 产物（形如 ***@*.*.*.zip）
      - name: Upload ZIP artifact (if any)
        uses: actions/upload-artifact@v4
        if: ${{ hashFiles(format('{0}/*@*.*.*.zip', matrix.dir)) != '' }}
        with:
          name: ${{ matrix.name }}-zip-${{ github.sha }}
          path: ${{ matrix.dir }}/*@*.*.*.zip
          retention-days: 7

      # 上传 dist-theme（若存在）
      - name: Upload dist-theme (if present)
        uses: actions/upload-artifact@v4
        if: ${{ hashFiles(format('{0}/dist-theme/**', matrix.dir)) != '' }}
        with:
          name: ${{ matrix.name }}-dist-theme-${{ github.sha }}
          path: ${{ matrix.dir }}/dist-theme/**
          retention-days: 7
