name: Component Release & AI Doc Sync

on:
  push:
    branches: [ "test/ci-branch" ] # ä»…åœ¨æµ‹è¯•åˆ†æ”¯æ¨é€æ—¶è§¦å‘
  workflow_dispatch:              # å¼€å¯æ‰‹åŠ¨è§¦å‘æŒ‰é’®

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate Plan
        id: set-matrix
        run: |
          # æ‰§è¡Œè„šæœ¬å¹¶å°† JSON ç»“æœå­˜å…¥è¾“å‡ºå˜é‡
          RESULT=$(node scripts/ci/plan-changed-packages.mjs)
          echo "matrix=$RESULT" >> $GITHUB_OUTPUT

  build-and-release:
    needs: plan
    # å¥å£®æ€§æ£€æŸ¥ï¼šåªæœ‰å½“å­˜åœ¨éœ€è¦å¤„ç†çš„åˆ†ç»„æ—¶æ‰è¿è¡Œ
    if: needs.plan.outputs.matrix != '' && fromJSON(needs.plan.outputs.matrix).include[0] != null
    strategy:
      fail-fast: false
      matrix:
        # æ ¸å¿ƒï¼šè¿™é‡Œå¼•ç”¨ .includeï¼Œè¿™æ ·æ¯ä¸€ä¸ª batch å¯¹è±¡å°±æ˜¯ä¸€ä¸ª matrix å•å…ƒ
        batch: ${{ fromJSON(needs.plan.outputs.matrix).include }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Process Component Batch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COREAGENT_TOKEN: ${{ secrets.COREAGENT_TOKEN }}
        run: |
          # 1. å°†è¯¥åˆ†ç»„çš„ items å­˜ä¸ºä¸´æ—¶æ–‡ä»¶ä¾› Node å¾ªç¯è¯»å–
          echo '${{ toJson(matrix.batch.items) }}' > batch_data.json
          
          # 2. è¿è¡Œ Node è„šæœ¬å¤„ç†è¯¥ç»„å†…çš„æ‰€æœ‰ç»„ä»¶
          node -e "
          const fs = require('fs');
          const cp = require('child_process');
          const path = require('path');
          const batch = JSON.parse(fs.readFileSync('batch_data.json', 'utf8'));

          for (const pkg of batch) {
            console.log('--- ğŸš€ Processing: ' + pkg.name + ' ---');
            
            // A. æ‰§è¡Œæ„å»º
            cp.execSync(pkg.build.join(' && '), { cwd: pkg.dir, stdio: 'inherit' });

            // B. æ‰“åŒ… ZIP (ä½¿ç”¨ä½ æµ‹è¯•æˆåŠŸçš„å‘½åé€»è¾‘)
            const zipName = \`\${pkg.name.replace(/[@/]/g, '-')}-v\${pkg.version}.zip\`;
            cp.execSync(\`zip -r \${zipName} dist/\`, { cwd: pkg.dir, stdio: 'inherit' });
            const zipPath = path.resolve(pkg.dir, zipName);

            // C. åˆ›å»ºç‹¬ç«‹ Release å¹¶ä¸Šä¼  ZIP
            // ä½¿ç”¨ç»„ä»¶å@ç‰ˆæœ¬å·-æ„å»ºå·ä½œä¸ºå”¯ä¸€ Tag
            const tagName = \`\${pkg.name}@\${pkg.version}-\${process.env.GITHUB_RUN_NUMBER}\`;
            try {
              cp.execSync(\`gh release create \"\${tagName}\" \"\${zipPath}\" --title \"\${pkg.name} v\${pkg.version}\" --notes \"Automated asset release\"\`, { stdio: 'inherit' });
            } catch (e) { console.warn('Release failed, check permissions or if tag exists.'); }

            // D. è°ƒç”¨æ™ºèƒ½ä½“æ›´æ–°æ–‡æ¡£
            // å‡è®¾ä½ å·²å‡†å¤‡å¥½ scripts/ci/sync-to-coreagent.mjs
            try {
              cp.execSync(\`node scripts/ci/sync-to-coreagent.mjs '\${JSON.stringify(pkg)}' \${tagName}\`, { stdio: 'inherit' });
            } catch (e) { console.error('AI Sync failed for ' + pkg.name); }
          }
          "