name: Release on Merge

on:
  push:
    branches: [main, master]

permissions:
  contents: write # 需要推 tag / 创建 release

jobs:
  plan:
    runs-on: ubuntu-latest
    env:
      # push 到 main/master 时强制全量，避免 diff 为空导致后续作业被跳过
      PLAN_ALL: ${{ (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) && '1' || '0' }}
    outputs:
      matrix: ${{ steps.plan.outputs.matrix }}
      count: ${{ steps.plan.outputs.count }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Generate matrix
        id: plan
        shell: bash
        run: |
          set -euo pipefail
          node scripts/ci/plan-changed-packages.mjs > matrix.json
          echo "matrix=$(jq -c '.include' matrix.json)" >> "$GITHUB_OUTPUT"
          echo "count=$(jq '.include | length' matrix.json)" >> "$GITHUB_OUTPUT"
          echo "==== Plan ===="
          cat matrix.json

      - name: Debug plan outputs
        shell: bash
        run: |
          echo "count=${{ steps.plan.outputs.count }}"
          echo "matrix=${{ steps.plan.outputs.matrix }}"

  build:
    needs: plan
    if: needs.plan.outputs.count != '0'
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.plan.outputs.matrix) }}

    defaults:
      run:
        working-directory: ${{ matrix.dir }}

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Setup Node ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Enable npm cache (if lockfile exists)
        if: ${{ hashFiles(format('{0}/package-lock.json', matrix.dir)) != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm
          cache-dependency-path: ${{ matrix.dir }}/package-lock.json

      # 仅 YAML (Node14/16) 需要 lcap
      - name: Install LCAP CLI (yaml only)
        if: ${{ matrix.node == '14' || matrix.node == '16' }}
        shell: bash
        run: |
          set -euo pipefail
          npm i -g lcap@latest || (echo "⚠️ lcap install failed" && exit 1)
          lcap --version || true

      - name: Build package
        shell: bash
        run: |
          set -euo pipefail
          node -e '
            const {execSync} = require("child_process");
            const steps = ${{ toJson(matrix.build) }};
            for (const cmd of steps) {
              console.log("+ " + cmd);
              execSync(cmd, {stdio:"inherit", shell:true});
            }
          '

      # 只收集 zip；保持原文件名；暂存到仓库根下的 _release/
      - name: Stash ZIPs to workspace
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/_release/${{ matrix.name }}"
          shopt -s nullglob
          zips=(*@*.*.*.zip)
          if ((${#zips[@]})); then
            cp -f "${zips[@]}" "$GITHUB_WORKSPACE/_release/${{ matrix.name }}/"
            printf 'copied: %s\n' "${zips[@]}"
          else
            echo "No zip found in $PWD"
          fi

      # 记录用于 Release 表格的汇总信息
      - name: Append summary row
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/_release/__meta"
          echo "${{ matrix.name }}|${{ matrix.stack || 'unknown' }}" >> "$GITHUB_WORKSPACE/_release/__meta/summary.tsv"

      # 将本 matrix 产物上传为工件，供 release 作业统一下载合并
      - name: Upload release part (per package)
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.name }}
          path: |
            _release/${{ matrix.name }}/*
            _release/__meta/summary.tsv
          if-no-files-found: ignore
          retention-days: 1

  release:
    needs: [plan, build]
    if: needs.plan.outputs.count != '0'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # 下载所有包的工件并合并成统一的 _release 目录结构
      - name: Download all release parts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: _artifacts
          merge-multiple: false

      - name: Merge artifacts into _release tree
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p _release/__meta
          touch _release/__meta/summary.tsv

          # 合并 zip
          while IFS= read -r -d '' f; do
            # f 形如 _artifacts/release-<name>/_release/<name>/<file>.zip
            rel="${f#*_artifacts/}"
            sub="${rel#*/_release/}"               # <name>/<file>.zip
            dest_dir="_release/${sub%/*}"          # _release/<name>
            mkdir -p "$dest_dir"
            cp -f "$f" "$dest_dir/"
          done < <(find _artifacts -type f -name '*@*.*.*.zip' -print0)

          # 合并 summary.tsv 去重
          while IFS= read -r -d '' s; do
            cat "$s" >> _release/__meta/summary.tsv
          done < <(find _artifacts -type f -path '*/_release/__meta/summary.tsv' -print0)
          sort -u _release/__meta/summary.tsv -o _release/__meta/summary.tsv || true

          echo "Merged tree:"
          ls -R _release || true

      - name: Configure git identity
        shell: bash
        run: |
          git config --global user.email "ci-bot@github-actions[bot].github.com"
          git config --global user.name  "GitHub Actions Bot"

      - name: Generate tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          TAG="build-$(date +'%Y%m%d')-${GITHUB_SHA::7}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Tag: $TAG"

      - name: Create annotated tag
        shell: bash
        run: |
          set -euo pipefail
          git tag -a "${{ steps.tag.outputs.tag }}" -m "CI release ${{ steps.tag.outputs.tag }}"
          git push origin "${{ steps.tag.outputs.tag }}"

      - name: Build release body markdown
        id: body
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "# Components in this release"
            echo
            if [[ -s _release/__meta/summary.tsv ]]; then
              echo "| Component | Stack | Assets |"
              echo "|---|---|---|"
              while IFS="|" read -r name stack; do
                stack=${stack:-unknown}
                shopt -s nullglob
                files=( _release/"$name"/*@*.*.*.zip )
                if ((${#files[@]})); then
                  assets=""
                  for z in "${files[@]}"; do
                    assets+=$(basename "$z")
                    assets+=" "
                  done
                else
                  assets="(none)"
                fi
                echo "| $name | $stack | $assets |"
              done < _release/__meta/summary.tsv
            else
              echo "_No components were summarized._"
            fi
          } > _release/__meta/RELEASE_BODY.md

          {
            echo 'body<<EOF'
            cat _release/__meta/RELEASE_BODY.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh release create "${{ steps.tag.outputs.tag }}" \
            --title "Release ${{ steps.tag.outputs.tag }}" \
            --notes-file _release/__meta/RELEASE_BODY.md

      - name: Upload zip assets to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          mapfile -t files < <(find _release -type f -name '*@*.*.*.zip' | sort)
          if ((${#files[@]})); then
            echo "Uploading ${#files[@]} assets…"
            gh release upload "${{ steps.tag.outputs.tag }}" "${files[@]}" --clobber
          else
            echo "No zip assets to upload."
          fi
