name: Component PR Artifacts (Fault-Tolerant)

on:
  push:
    branches: ["test-ci-branch", "main"]
  workflow_dispatch:
    inputs:
      build_all:
        description: "æ„å»ºæ‰€æœ‰åŒ…ï¼ˆå¿½ç•¥å˜æ›´æ£€æµ‹ï¼‰"
        required: false
        type: boolean
      test_package:
        description: "æµ‹è¯•å•ä¸ªåŒ…ï¼ˆè¾“å…¥åŒ…åï¼Œå¦‚ï¼šcw_countupï¼‰"
        required: false
        type: string

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      skip_ci: ${{ steps.check-skip-ci.outputs.skip_ci }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # PR äº‹ä»¶æ—¶ï¼Œéœ€è¦ checkout PR çš„ head å’Œ base
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          # é…ç½® token å’ŒæŒä¹…åŒ–å‡­æ®ï¼ˆè™½ç„¶ plan job ä¸éœ€è¦ pushï¼Œä½†ä¿æŒä¸€è‡´æ€§ï¼‰
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      - name: Check for skip CI
        if: github.event_name == 'push'
        run: |
          # æ£€æŸ¥æœ€è¿‘çš„æäº¤ä¿¡æ¯æ˜¯å¦åŒ…å« [skip ci] æ ‡è®°
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -qiE '\[skip ci\]|\[ci skip\]|\[no ci\]|\[skip actions\]|\[actions skip\]'; then
            echo "â­ï¸ æ£€æµ‹åˆ° [skip ci] æ ‡è®°ï¼Œè·³è¿‡å·¥ä½œæµæ‰§è¡Œ"
            echo "skip_ci=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… æœªæ£€æµ‹åˆ° [skip ci] æ ‡è®°ï¼Œç»§ç»­æ‰§è¡Œå·¥ä½œæµ"
            echo "skip_ci=false" >> $GITHUB_OUTPUT
          fi
        id: check-skip-ci
      - name: Fetch Base Branch (for PR events)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}
      - name: Setup Node
        if: |
          github.event_name != 'push' || 
          steps['check-skip-ci'].outputs.skip_ci != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Generate Plan
        if: |
          github.event_name != 'push' || 
          steps['check-skip-ci'].outputs.skip_ci != 'true'
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.test_package }}" ]; then
            echo "ğŸ§ª æµ‹è¯•æ¨¡å¼ï¼šæ„å»ºæŒ‡å®šåŒ… '${{ github.event.inputs.test_package }}'"
            RESULT=$(TEST_PACKAGE="${{ github.event.inputs.test_package }}" node scripts/ci/plan-changed-packages.mjs)
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.build_all }}" = "true" ]; then
            echo "ğŸ”§ æ‰‹åŠ¨è§¦å‘ï¼šæ„å»ºæ‰€æœ‰åŒ…"
            RESULT=$(PLAN_ALL=1 node scripts/ci/plan-changed-packages.mjs)
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            echo "ğŸ”§ PR åˆå¹¶ï¼šæ£€æµ‹ PR ä¸­çš„å˜æ›´"
            # PR åˆå¹¶æ—¶ï¼Œä½¿ç”¨ PR çš„ base å’Œ head æ¥æ£€æµ‹å˜æ›´
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            RESULT=$(node scripts/ci/plan-changed-packages.mjs "$BASE_SHA...$HEAD_SHA")
          elif [ "${{ github.event_name }}" = "push" ] && [ -n "${{ github.event.before }}" ] && [ -n "${{ github.event.after }}" ]; then
            echo "ğŸ”§ Push äº‹ä»¶ï¼šæ£€æµ‹å˜æ›´çš„åŒ…"
            # Push äº‹ä»¶æ—¶ï¼Œä½¿ç”¨ before å’Œ after æ¥æ£€æµ‹å˜æ›´
            RESULT=$(node scripts/ci/plan-changed-packages.mjs "${{ github.event.before }}...${{ github.event.after }}")
          else
            echo "ğŸ”§ å¢é‡æ„å»ºï¼šæ£€æµ‹å˜æ›´çš„åŒ…"
            RESULT=$(node scripts/ci/plan-changed-packages.mjs)
          fi
          echo "matrix=$RESULT" >> $GITHUB_OUTPUT

          # è§£æç»“æœå¹¶æ˜¾ç¤ºä¿¡æ¯
          BATCH_COUNT=$(echo "$RESULT" | node -e "const d=require('fs').readFileSync(0,'utf8'); const j=JSON.parse(d); console.log(j.include?.length || 0)")
          TOTAL_PACKAGES=$(echo "$RESULT" | node -e "const d=require('fs').readFileSync(0,'utf8'); const j=JSON.parse(d); const total = j.include?.reduce((s,b)=>s+(b.items?.length||0),0) || 0; console.log(total)")

          if [ "$BATCH_COUNT" = "0" ]; then
            echo "âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦æ„å»ºçš„åŒ…"
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "ğŸ’¡ æç¤ºï¼š"
              echo "   - å‹¾é€‰ 'æ„å»ºæ‰€æœ‰åŒ…' é€‰é¡¹æ¥æ„å»ºæ‰€æœ‰åŒ…"
              echo "   - æˆ–åœ¨ 'æµ‹è¯•å•ä¸ªåŒ…' ä¸­è¾“å…¥åŒ…åï¼ˆå¦‚ï¼šcw_countupï¼‰"
            fi
          else
            echo "âœ… æ£€æµ‹åˆ° $BATCH_COUNT ä¸ªæ‰¹æ¬¡ï¼Œå…± $TOTAL_PACKAGES ä¸ªåŒ…éœ€è¦æ„å»º"
          fi

  build-and-comment:
    needs: plan
    if: |
      needs.plan.outputs.skip_ci != 'true' &&
      needs.plan.outputs.matrix != '' &&
      fromJSON(needs.plan.outputs.matrix).include != null &&
      fromJSON(needs.plan.outputs.matrix).include[0] != null &&
      (
        github.event_name == 'push' ||
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
      )
    strategy:
      fail-fast: false
      matrix:
        batch: ${{ fromJSON(needs.plan.outputs.matrix).include }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # å¯¹äº push äº‹ä»¶ï¼Œcheckout åˆ°åˆ†æ”¯ï¼›å¯¹äº PR åˆå¹¶äº‹ä»¶ï¼Œcheckout åˆ°ç›®æ ‡åˆ†æ”¯
          ref: ${{ github.event_name == 'push' && github.ref || github.event.pull_request.base.ref || github.ref }}
          # é…ç½® token å’ŒæŒä¹…åŒ–å‡­æ®ï¼Œä»¥ä¾¿åç»­å¯ä»¥ push ä»£ç 
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Git Branch for Push
        run: |
          # ç¡®ä¿åœ¨æ­£ç¡®çš„åˆ†æ”¯ä¸Šï¼Œé¿å… detached HEAD çŠ¶æ€
          if [ "${{ github.event_name }}" = "push" ]; then
            # Push äº‹ä»¶ï¼šä» refs/heads/branch-name æå–åˆ†æ”¯å
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
            echo "ğŸ“Œ å½“å‰åˆ†æ”¯: $BRANCH_NAME"
            git checkout -B "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            # PR åˆå¹¶äº‹ä»¶ï¼šcheckout åˆ°ç›®æ ‡åˆ†æ”¯
            BRANCH_NAME="${{ github.event.pull_request.base.ref }}"
            echo "ğŸ“Œ PR åˆå¹¶åˆ°åˆ†æ”¯: $BRANCH_NAME"
            git fetch origin "$BRANCH_NAME:$BRANCH_NAME" || true
            git checkout -B "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          else
            # å…¶ä»–æƒ…å†µï¼šå°è¯•ä» GITHUB_REF è·å–åˆ†æ”¯å
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
            if [ "$BRANCH_NAME" != "$GITHUB_REF" ]; then
              echo "ğŸ“Œ ä½¿ç”¨åˆ†æ”¯: $BRANCH_NAME"
              git checkout -B "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
            else
              echo "âš ï¸ æ— æ³•ç¡®å®šåˆ†æ”¯åï¼Œä½¿ç”¨å½“å‰ HEAD"
            fi
          fi
          # æ˜¾ç¤ºå½“å‰åˆ†æ”¯çŠ¶æ€
          echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
          echo "HEAD çŠ¶æ€: $(git rev-parse --abbrev-ref HEAD)"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install LCAP
        run: |
          npm install -g lcap@latest
          lcap config set platform https://defaulttenant.lcap.hadri.163yun.com
          lcap config set username admin
          lcap config set password Admin@123456

      - name: Install pnpm
        run: |
          corepack enable
          corepack prepare pnpm@8 --activate
          pnpm --version

      - name: Setup Dependencies (Stubs & Config)
        run: node scripts/ci/setup-dependencies.mjs

      - name: Configure Turbo
        run: node scripts/ci/configure-turbo.mjs

      - name: Install Root Dependencies
        run: |
          echo "ğŸš€ å¼€å§‹å®‰è£…æ ¹ç›®å½•ä¾èµ–..."
          # å®‰è£…æ ¹ç›®å½•ä¾èµ–ï¼ˆåŒ…æ‹¬ turboï¼‰ï¼Œä¸ä½¿ç”¨ --ignore-scripts ä»¥è§¦å‘ postinstall
          pnpm install --prefer-offline --no-frozen-lockfile || true
          echo "âœ… æ ¹ç›®å½•ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Install Workspace Dependencies
        run: |
          echo "ğŸš€ å¼€å§‹å®‰è£…å„å·¥ä½œåŒºä¾èµ–..."
          # æ˜¾å¼æ‰§è¡Œå·¥ä½œåŒºå®‰è£…è„šæœ¬ï¼ˆç¡®ä¿æ‰€æœ‰å­å·¥ä½œåŒºçš„ä¾èµ–éƒ½å®‰è£…ï¼‰
          # è¿™ä¼šä¸ºæ¯ä¸ªå·¥ä½œåŒºï¼ˆlegacy-yaml, ts-vue2 ç­‰ï¼‰æ‰§è¡Œ pnpm install
          node scripts/mono/install-all-workspaces.mjs || true
          echo "âœ… å·¥ä½œåŒºä¾èµ–å®‰è£…å®Œæˆ"

      - name: Verify Critical Dependencies
        run: |
          echo "ğŸ” éªŒè¯å…³é”®ä¾èµ–..."
          # æ£€æŸ¥ turbo æ˜¯å¦å¯ç”¨
          if ! command -v turbo &> /dev/null; then
            echo "âš ï¸ turbo æœªæ‰¾åˆ°ï¼Œå°è¯•å…¨å±€å®‰è£…..."
            npm install -g turbo@2.5.8
          else
            echo "âœ… turbo å·²å®‰è£…: $(turbo --version)"
          fi

          # éªŒè¯ pnpm å·¥ä½œåŒºæ˜¯å¦æ­£ç¡®è¯†åˆ«
          echo "ğŸ“¦ éªŒè¯ pnpm å·¥ä½œåŒº..."
          pnpm list --depth=0 --json > /dev/null 2>&1 && echo "âœ… pnpm å·¥ä½œåŒºé…ç½®æ­£å¸¸" || echo "âš ï¸ pnpm å·¥ä½œåŒºé…ç½®å¯èƒ½æœ‰é—®é¢˜"

          echo "âœ… ä¾èµ–éªŒè¯å®Œæˆ"

      - name: Build and Package
        id: build-package
        continue-on-error: false
        run: |
          echo '${{ toJson(matrix.batch.items) }}' > batch_items.json
          node scripts/ci/build-and-package.mjs
        env:
          # Turbo è¿œç¨‹ç¼“å­˜é…ç½®ï¼ˆå¯é€‰ï¼‰
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

      - name: Check Build Results
        id: check-build-results
        if: always()
        continue-on-error: true
        run: |
          echo "ğŸ” æ£€æŸ¥æ„å»ºç»“æœ..."
          SUCCESS_COUNT=0
          FAIL_COUNT=0

          if [ -f "build_results.json" ]; then
            SUCCESS_COUNT=$(node -e "const fs=require('fs'); const data=JSON.parse(fs.readFileSync('build_results.json','utf8')); console.log(data.filter(r=>r.status==='success').length)")
            FAIL_COUNT=$(node -e "const fs=require('fs'); const data=JSON.parse(fs.readFileSync('build_results.json','utf8')); console.log(data.filter(r=>r.status==='failed').length)")
            
            echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
            echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT
            
            if [ "$SUCCESS_COUNT" -gt 0 ]; then
              echo "âœ… æ£€æµ‹åˆ° $SUCCESS_COUNT ä¸ªåŒ…æ„å»ºæˆåŠŸ"
            fi
            
            if [ "$FAIL_COUNT" -gt 0 ]; then
              echo "âŒ æ£€æµ‹åˆ° $FAIL_COUNT ä¸ªåŒ…æ„å»ºå¤±è´¥"
              echo ""
              echo "å¤±è´¥è¯¦æƒ…:"
              node -e "
                const fs = require('fs');
                const data = JSON.parse(fs.readFileSync('build_results.json', 'utf8'));
                data
                  .filter(r => r.status === 'failed')
                  .forEach(r => {
                    console.log(\`  - \${r.name}: \${r.error}\`);
                  });
              "
            fi
            
            # åªè¦æœ‰æˆåŠŸæ„å»ºçš„åŒ…å°±ç»§ç»­ï¼Œä¸é€€å‡º
            if [ "$SUCCESS_COUNT" -gt 0 ]; then
              echo "âœ… æœ‰ $SUCCESS_COUNT ä¸ªåŒ…æ„å»ºæˆåŠŸï¼Œå°†ç»§ç»­æ‰§è¡Œä¸Šä¼ æµç¨‹"
            else
              echo "âš ï¸ æ²¡æœ‰æˆåŠŸæ„å»ºçš„åŒ…ï¼Œå°†è·³è¿‡ä¸Šä¼ æµç¨‹"
            fi
          else
            echo "âš ï¸ æ„å»ºç»“æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯"
            echo "success_count=0" >> $GITHUB_OUTPUT
            echo "fail_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate Diff Description and Update Documentation
        if: |
          always() &&
          steps['check-build-results'].outcome == 'success' &&
          steps['check-build-results'].outputs.success_count > 0
        run: node scripts/ci/generate-diff-docs.mjs
        env:
          COREAGENT_APP_ID: ${{ secrets.COREAGENT_APP_ID }}
          COREAGENT_APP_KEY: ${{ secrets.COREAGENT_APP_KEY }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          BASE_URL: ${{ vars.UPLOAD_API_URL }}
          UPLOAD_API_TOKEN: ${{ secrets.UPLOAD_API_TOKEN }}
          UPLOAD_DOMAIN_NAME: ${{ vars.UPLOAD_DOMAIN_NAME }}
          UPLOAD_CONNECTION_GROUP: ${{ vars.UPLOAD_CONNECTION_GROUP }}
          UPLOAD_FAIL_CONTINUE: "true"

      - name: Upload Packages
        if: |
          always() &&
          steps['check-build-results'].outcome == 'success' &&
          steps['check-build-results'].outputs.success_count > 0
        run: |
          echo "ğŸ“¤ å¼€å§‹ä¸Šä¼ æ„å»ºæˆåŠŸçš„åŒ…..."
          node scripts/ci/upload-packages.mjs
        env:
          BASE_URL: ${{ vars.UPLOAD_API_URL }}
          UPLOAD_API_TOKEN: ${{ secrets.UPLOAD_API_TOKEN }}
          UPLOAD_DOMAIN_NAME: ${{ vars.UPLOAD_DOMAIN_NAME }}
          UPLOAD_CONNECTION_GROUP: ${{ vars.UPLOAD_CONNECTION_GROUP }}
          UPLOAD_FAIL_CONTINUE: "true"
